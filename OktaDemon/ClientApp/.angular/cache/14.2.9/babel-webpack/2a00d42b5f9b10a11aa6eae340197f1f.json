{"ast":null,"code":"/*!\n * Copyright (c) 2015-present, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * \n * See the License for the specific language governing permissions and limitations under the License.\n */\nimport { removeNils, clone } from '../util/object.js';\nimport { isString } from '../util/types.js';\nimport { isAbsoluteUrl } from '../util/url.js';\nimport { STATE_TOKEN_KEY_NAME, DEFAULT_CACHE_DURATION } from '../constants.js';\nimport AuthApiError from '../errors/AuthApiError.js';\nimport OAuthError from '../errors/OAuthError.js';\n\nfunction httpRequest(sdk, options) {\n  options = options || {};\n\n  if (sdk.options.httpRequestInterceptors) {\n    for (const interceptor of sdk.options.httpRequestInterceptors) {\n      interceptor(options);\n    }\n  }\n\n  var url = options.url,\n      method = options.method,\n      args = options.args,\n      saveAuthnState = options.saveAuthnState,\n      accessToken = options.accessToken,\n      withCredentials = options.withCredentials === true,\n      storageUtil = sdk.options.storageUtil,\n      storage = storageUtil.storage,\n      httpCache = sdk.storageManager.getHttpCache(sdk.options.cookies);\n\n  if (options.cacheResponse) {\n    var cacheContents = httpCache.getStorage();\n    var cachedResponse = cacheContents[url];\n\n    if (cachedResponse && Date.now() / 1000 < cachedResponse.expiresAt) {\n      return Promise.resolve(cachedResponse.response);\n    }\n  }\n\n  var oktaUserAgentHeader = sdk._oktaUserAgent.getHttpHeader();\n\n  var headers = Object.assign({\n    'Accept': 'application/json',\n    'Content-Type': 'application/json'\n  }, oktaUserAgentHeader);\n  Object.assign(headers, sdk.options.headers, options.headers);\n  headers = removeNils(headers);\n\n  if (accessToken && isString(accessToken)) {\n    headers['Authorization'] = 'Bearer ' + accessToken;\n  }\n\n  var ajaxOptions = {\n    headers,\n    data: args || undefined,\n    withCredentials\n  };\n  var err, res;\n  return sdk.options.httpRequestClient(method, url, ajaxOptions).then(function (resp) {\n    res = resp.responseText;\n\n    if (res && isString(res)) {\n      res = JSON.parse(res);\n\n      if (res && typeof res === 'object' && !res.headers) {\n        if (Array.isArray(res)) {\n          res.forEach(item => {\n            item.headers = resp.headers;\n          });\n        } else {\n          res.headers = resp.headers;\n        }\n      }\n    }\n\n    if (saveAuthnState) {\n      if (!res.stateToken) {\n        storage.delete(STATE_TOKEN_KEY_NAME);\n      }\n    }\n\n    if (res && res.stateToken && res.expiresAt) {\n      storage.set(STATE_TOKEN_KEY_NAME, res.stateToken, res.expiresAt, sdk.options.cookies);\n    }\n\n    if (res && options.cacheResponse) {\n      httpCache.updateStorage(url, {\n        expiresAt: Math.floor(Date.now() / 1000) + DEFAULT_CACHE_DURATION,\n        response: res\n      });\n    }\n\n    return res;\n  }).catch(function (resp) {\n    var serverErr = resp.responseText || {};\n\n    if (isString(serverErr)) {\n      try {\n        serverErr = JSON.parse(serverErr);\n      } catch (e) {\n        serverErr = {\n          errorSummary: 'Unknown error'\n        };\n      }\n    }\n\n    if (resp.status >= 500) {\n      serverErr.errorSummary = 'Unknown error';\n    }\n\n    if (sdk.options.transformErrorXHR) {\n      resp = sdk.options.transformErrorXHR(clone(resp));\n    }\n\n    if (serverErr.error && serverErr.error_description) {\n      err = new OAuthError(serverErr.error, serverErr.error_description);\n    } else {\n      err = new AuthApiError(serverErr, resp);\n    }\n\n    if (err.errorCode === 'E0000011') {\n      storage.delete(STATE_TOKEN_KEY_NAME);\n    }\n\n    throw err;\n  });\n}\n\nfunction get(sdk, url, options) {\n  url = isAbsoluteUrl(url) ? url : sdk.getIssuerOrigin() + url;\n  var getOptions = {\n    url: url,\n    method: 'GET'\n  };\n  Object.assign(getOptions, options);\n  return httpRequest(sdk, getOptions);\n}\n\nfunction post(sdk, url, args, options) {\n  url = isAbsoluteUrl(url) ? url : sdk.getIssuerOrigin() + url;\n  var postOptions = {\n    url: url,\n    method: 'POST',\n    args: args,\n    saveAuthnState: true\n  };\n  Object.assign(postOptions, options);\n  return httpRequest(sdk, postOptions);\n}\n\nexport { get, httpRequest, post }; //# sourceMappingURL=request.js.map","map":null,"metadata":{},"sourceType":"module"}