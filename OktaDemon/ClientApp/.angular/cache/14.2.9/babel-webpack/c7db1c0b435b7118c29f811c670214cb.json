{"ast":null,"code":"/*!\n * Copyright (c) 2017-Present, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\nimport { __awaiter } from 'tslib';\nimport * as i0 from '@angular/core';\nimport { InjectionToken, ɵɵngDeclareFactory, Injector, ɵɵFactoryTarget, ɵɵngDeclareComponent, ɵɵngDeclareClassMetadata, Component, Inject, Optional, ɵɵngDeclareInjectable, Injectable, TemplateRef, ViewContainerRef, ɵɵngDeclareDirective, Directive, Input, VERSION, ɵɵngDeclareNgModule, ɵɵngDeclareInjector, NgModule } from '@angular/core';\nimport { Router, NavigationStart } from '@angular/router';\nimport { Location } from '@angular/common';\nimport { OktaAuth, AuthSdkError, toRelativeUrl } from '@okta/okta-auth-js';\nimport { filter, mergeMap } from 'rxjs/operators';\nimport { BehaviorSubject } from 'rxjs';\nimport { compare } from 'compare-versions';\n/*\n * Copyright (c) 2017-Present, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\nconst OKTA_CONFIG = new InjectionToken('okta.config.angular');\nconst OKTA_AUTH = new InjectionToken('okta.auth');\nlet OktaCallbackComponent = /*#__PURE__*/(() => {\n  class OktaCallbackComponent {\n    constructor(config, oktaAuth, injector) {\n      this.config = config;\n      this.oktaAuth = oktaAuth;\n      this.injector = injector;\n    }\n\n    ngOnInit() {\n      return __awaiter(this, void 0, void 0, function* () {\n        try {\n          // Parse code or tokens from the URL, store tokens in the TokenManager, and redirect back to the originalUri\n          yield this.oktaAuth.handleLoginRedirect();\n        } catch (e) {\n          // Callback from social IDP. Show custom login page to continue.\n          // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n          // @ts-ignore Supports auth-js v5 & v6-7\n          const isInteractionRequiredError = this.oktaAuth.isInteractionRequiredError || this.oktaAuth.idx.isInteractionRequiredError;\n\n          if (isInteractionRequiredError(e) && this.injector) {\n            const {\n              onAuthResume,\n              onAuthRequired\n            } = this.config;\n            const callbackFn = onAuthResume || onAuthRequired;\n\n            if (callbackFn) {\n              callbackFn(this.oktaAuth, this.injector);\n              return;\n            }\n          }\n\n          this.error = e.toString();\n        }\n      });\n    }\n\n  }\n\n  OktaCallbackComponent.ɵfac = function OktaCallbackComponent_Factory(t) {\n    return new (t || OktaCallbackComponent)(i0.ɵɵdirectiveInject(OKTA_CONFIG), i0.ɵɵdirectiveInject(OKTA_AUTH), i0.ɵɵdirectiveInject(Injector, 8));\n  };\n\n  OktaCallbackComponent.ɵcmp = /* @__PURE__ */i0.ɵɵdefineComponent({\n    type: OktaCallbackComponent,\n    selectors: [[\"ng-component\"]],\n    decls: 2,\n    vars: 1,\n    template: function OktaCallbackComponent_Template(rf, ctx) {\n      if (rf & 1) {\n        i0.ɵɵelementStart(0, \"div\");\n        i0.ɵɵtext(1);\n        i0.ɵɵelementEnd();\n      }\n\n      if (rf & 2) {\n        i0.ɵɵadvance(1);\n        i0.ɵɵtextInterpolate(ctx.error);\n      }\n    },\n    encapsulation: 2\n  });\n  return OktaCallbackComponent;\n})();\n\n(function () {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && void 0;\n})();\n\nlet OktaAuthGuard = /*#__PURE__*/(() => {\n  class OktaAuthGuard {\n    constructor(config, oktaAuth, injector) {\n      this.config = config;\n      this.oktaAuth = oktaAuth;\n      this.injector = injector;\n\n      this.updateAuthStateListener = authState => {\n        if (!authState.isAuthenticated) {\n          this.handleLogin(this.state.url);\n        }\n      };\n\n      this.onAuthRequired = this.config.onAuthRequired; // Unsubscribe updateAuthStateListener when route change\n\n      const router = injector.get(Router);\n      router.events.pipe(filter(e => e instanceof NavigationStart && this.state && this.state.url !== e.url)).subscribe(() => {\n        this.oktaAuth.authStateManager.unsubscribe(this.updateAuthStateListener);\n      });\n    }\n\n    canLoad(route) {\n      return __awaiter(this, void 0, void 0, function* () {\n        this.onAuthRequired = route.data && route.data.onAuthRequired || this.onAuthRequired;\n        const isAuthenticated = yield this.oktaAuth.isAuthenticated();\n\n        if (isAuthenticated) {\n          return true;\n        }\n\n        const router = this.injector.get(Router);\n        const nav = router.getCurrentNavigation();\n        const originalUri = nav ? nav.extractedUrl.toString() : undefined;\n        yield this.handleLogin(originalUri);\n        return false;\n      });\n    }\n    /**\n     * Gateway for protected route. Returns true if there is a valid accessToken,\n     * otherwise it will cache the route and start the login flow.\n     * @param route\n     * @param state\n     */\n\n\n    canActivate(route, state) {\n      return __awaiter(this, void 0, void 0, function* () {\n        // Track states for current route\n        this.state = state;\n        this.onAuthRequired = route.data && route.data.onAuthRequired || this.onAuthRequired; // Protect the route after accessing\n\n        this.oktaAuth.authStateManager.subscribe(this.updateAuthStateListener);\n        const isAuthenticated = yield this.oktaAuth.isAuthenticated();\n\n        if (isAuthenticated) {\n          return true;\n        }\n\n        yield this.handleLogin(state.url);\n        return false;\n      });\n    }\n\n    canActivateChild(route, state) {\n      return __awaiter(this, void 0, void 0, function* () {\n        return this.canActivate(route, state);\n      });\n    }\n\n    handleLogin(originalUri) {\n      return __awaiter(this, void 0, void 0, function* () {\n        // Store the current path\n        if (originalUri) {\n          this.oktaAuth.setOriginalUri(originalUri);\n        }\n\n        if (this.onAuthRequired) {\n          this.onAuthRequired(this.oktaAuth, this.injector);\n        } else {\n          this.oktaAuth.signInWithRedirect();\n        }\n      });\n    }\n\n  }\n\n  OktaAuthGuard.ɵfac = function OktaAuthGuard_Factory(t) {\n    return new (t || OktaAuthGuard)(i0.ɵɵinject(OKTA_CONFIG), i0.ɵɵinject(OKTA_AUTH), i0.ɵɵinject(Injector));\n  };\n\n  OktaAuthGuard.ɵprov = /* @__PURE__ */i0.ɵɵdefineInjectable({\n    token: OktaAuthGuard,\n    factory: OktaAuthGuard.ɵfac\n  });\n  return OktaAuthGuard;\n})();\n\n(function () {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && void 0;\n})();\n\nconst defaultAuthState = {\n  isAuthenticated: false\n};\nlet OktaAuthStateService = /*#__PURE__*/(() => {\n  class OktaAuthStateService {\n    constructor(oktaAuth) {\n      this.oktaAuth = oktaAuth;\n      this._authState = new BehaviorSubject(defaultAuthState); // only expose readonly property\n\n      this.authState$ = this._authState.asObservable();\n      this.updateAuthState = this.updateAuthState.bind(this); // set initial authState\n\n      const initialAuthState = this.oktaAuth.authStateManager.getAuthState() || defaultAuthState;\n\n      this._authState.next(initialAuthState); // subscribe to future changes\n\n\n      this.oktaAuth.authStateManager.subscribe(this.updateAuthState);\n    }\n\n    ngOnDestroy() {\n      this.oktaAuth.authStateManager.unsubscribe(this.updateAuthState);\n    } // Observes as true when any group input can match groups from user claims \n\n\n    hasAnyGroups(groups) {\n      return this.authState$.pipe(mergeMap(({\n        isAuthenticated,\n        idToken\n      }) => __awaiter(this, void 0, void 0, function* () {\n        // return false when not authenticated or openid is not in scopes\n        if (!isAuthenticated || !idToken) {\n          return false;\n        } // transform inputs to consistent object format\n\n\n        if (typeof groups === 'string') {\n          groups = {\n            groups: [groups]\n          };\n        }\n\n        if (Array.isArray(groups)) {\n          groups = {\n            groups\n          };\n        }\n\n        const key = Object.keys(groups)[0];\n        const value = groups[key]; // groups or custom claims is available in idToken\n\n        if (idToken.claims[key]) {\n          return value.some(authority => idToken.claims[key].includes(authority));\n        } // try /userinfo endpoint when thin idToken (no groups claim) is returned\n        // https://developer.okta.com/docs/concepts/api-access-management/#tokens-and-scopes\n\n\n        const userInfo = yield this.oktaAuth.getUser();\n\n        if (!userInfo[key]) {\n          return false;\n        }\n\n        return value.some(authority => userInfo[key].includes(authority));\n      })));\n    }\n\n    updateAuthState(authState) {\n      this._authState.next(authState);\n    }\n\n  }\n\n  OktaAuthStateService.ɵfac = function OktaAuthStateService_Factory(t) {\n    return new (t || OktaAuthStateService)(i0.ɵɵinject(OKTA_AUTH));\n  };\n\n  OktaAuthStateService.ɵprov = /* @__PURE__ */i0.ɵɵdefineInjectable({\n    token: OktaAuthStateService,\n    factory: OktaAuthStateService.ɵfac\n  });\n  return OktaAuthStateService;\n})();\n\n(function () {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && void 0;\n})();\n\nlet OktaHasAnyGroupDirective = /*#__PURE__*/(() => {\n  class OktaHasAnyGroupDirective {\n    constructor( // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    templateRef, viewContainer, authStateService) {\n      this.templateRef = templateRef;\n      this.viewContainer = viewContainer;\n      this.authStateService = authStateService;\n    }\n\n    set oktaHasAnyGroup(groups) {\n      this.authStateService.hasAnyGroups(groups).subscribe(isAuthorized => {\n        // don't update UI if no state change\n        if (isAuthorized === this.previousIsAuthorized) {\n          return;\n        }\n\n        this.previousIsAuthorized = isAuthorized;\n        this.viewContainer.clear();\n\n        if (isAuthorized) {\n          this.viewContainer.createEmbeddedView(this.templateRef);\n        }\n      });\n    }\n\n  }\n\n  OktaHasAnyGroupDirective.ɵfac = function OktaHasAnyGroupDirective_Factory(t) {\n    return new (t || OktaHasAnyGroupDirective)(i0.ɵɵdirectiveInject(TemplateRef), i0.ɵɵdirectiveInject(ViewContainerRef), i0.ɵɵdirectiveInject(OktaAuthStateService));\n  };\n\n  OktaHasAnyGroupDirective.ɵdir = /* @__PURE__ */i0.ɵɵdefineDirective({\n    type: OktaHasAnyGroupDirective,\n    selectors: [[\"\", \"oktaHasAnyGroup\", \"\"]],\n    inputs: {\n      oktaHasAnyGroup: \"oktaHasAnyGroup\"\n    }\n  });\n  return OktaHasAnyGroupDirective;\n})();\n\n(function () {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && void 0;\n})();\n\nvar packageInfo = {\n  'name': '@okta/okta-angular',\n  'version': '6.0.0',\n  'authJSMinSupportedVersion': '5.3.1'\n};\n\nfunction oktaAuthFactory(config) {\n  return config.oktaAuth;\n}\n\nlet OktaAuthModule = /*#__PURE__*/(() => {\n  class OktaAuthModule {\n    constructor(config, location, router) {\n      const {\n        oktaAuth\n      } = config;\n      const isAuthJsSupported = oktaAuth._oktaUserAgent && compare(oktaAuth._oktaUserAgent.getVersion(), packageInfo.authJSMinSupportedVersion, '>=');\n\n      if (!isAuthJsSupported) {\n        throw new AuthSdkError(`Passed in oktaAuth is not compatible with the SDK, minimum supported okta-auth-js version is ${packageInfo.authJSMinSupportedVersion}.`);\n      } // Add Okta UA\n\n\n      oktaAuth._oktaUserAgent.addEnvironment(`${packageInfo.name}/${packageInfo.version}`);\n\n      oktaAuth._oktaUserAgent.addEnvironment(`Angular/${VERSION.full}`); // Provide a default implementation of `restoreOriginalUri`\n\n\n      if (!oktaAuth.options.restoreOriginalUri && router && location) {\n        oktaAuth.options.restoreOriginalUri = (_, originalUri) => __awaiter(this, void 0, void 0, function* () {\n          const baseUrl = window.location.origin + location.prepareExternalUrl('');\n          const routePath = toRelativeUrl(originalUri || '/', baseUrl);\n          router.navigateByUrl(routePath);\n        });\n      } // Start services\n\n\n      oktaAuth.start();\n    }\n\n  }\n\n  OktaAuthModule.ɵfac = function OktaAuthModule_Factory(t) {\n    return new (t || OktaAuthModule)(i0.ɵɵinject(OKTA_CONFIG), i0.ɵɵinject(Location, 8), i0.ɵɵinject(Router, 8));\n  };\n\n  OktaAuthModule.ɵmod = /* @__PURE__ */i0.ɵɵdefineNgModule({\n    type: OktaAuthModule\n  });\n  OktaAuthModule.ɵinj = /* @__PURE__ */i0.ɵɵdefineInjector({\n    providers: [OktaAuthGuard, OktaAuthStateService, {\n      provide: OKTA_AUTH,\n      useFactory: oktaAuthFactory,\n      deps: [OKTA_CONFIG]\n    }]\n  });\n  return OktaAuthModule;\n})();\n\n(function () {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && void 0;\n})();\n\nexport { OKTA_AUTH, OKTA_CONFIG, OktaAuthGuard, OktaAuthModule, OktaAuthStateService, OktaCallbackComponent, OktaHasAnyGroupDirective }; //# sourceMappingURL=okta-angular.js.map","map":null,"metadata":{},"sourceType":"module"}