{"ast":null,"code":"/*!\n * Copyright (c) 2015-present, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * \n * See the License for the specific language governing permissions and limitations under the License.\n */\nimport AuthPollStopError from '../../errors/AuthPollStopError.js';\nimport AuthSdkError from '../../errors/AuthSdkError.js';\nimport { delay } from '../../util/misc.js';\nimport { getLink } from '../../util/object.js';\nimport { isNumber, isObject } from '../../util/types.js';\nimport { toQueryString } from '../../util/url.js';\nimport { post } from '../../http/request.js';\nimport { DEFAULT_POLLING_DELAY } from '../../constants.js';\nimport 'tiny-emitter';\nimport 'js-cookie';\nimport 'cross-fetch';\nimport { getStateToken } from './stateToken.js';\n\nfunction getPollFn(sdk, res, ref) {\n  return function (options) {\n    var delay$1;\n    var rememberDevice;\n    var autoPush;\n    var transactionCallBack;\n\n    if (isNumber(options)) {\n      delay$1 = options;\n    } else if (isObject(options)) {\n      options = options;\n      delay$1 = options.delay;\n      rememberDevice = options.rememberDevice;\n      autoPush = options.autoPush;\n      transactionCallBack = options.transactionCallBack;\n    }\n\n    if (!delay$1 && delay$1 !== 0) {\n      delay$1 = DEFAULT_POLLING_DELAY;\n    }\n\n    var pollLink = getLink(res, 'next', 'poll');\n\n    function pollFn() {\n      var opts = {};\n\n      if (typeof autoPush === 'function') {\n        try {\n          opts.autoPush = !!autoPush();\n        } catch (e) {\n          return Promise.reject(new AuthSdkError('AutoPush resulted in an error.'));\n        }\n      } else if (autoPush !== undefined && autoPush !== null) {\n        opts.autoPush = !!autoPush;\n      }\n\n      if (typeof rememberDevice === 'function') {\n        try {\n          opts.rememberDevice = !!rememberDevice();\n        } catch (e) {\n          return Promise.reject(new AuthSdkError('RememberDevice resulted in an error.'));\n        }\n      } else if (rememberDevice !== undefined && rememberDevice !== null) {\n        opts.rememberDevice = !!rememberDevice;\n      }\n\n      var href = pollLink.href + toQueryString(opts);\n      return post(sdk, href, getStateToken(res), {\n        saveAuthnState: false,\n        withCredentials: true\n      });\n    }\n\n    ref.isPolling = true;\n    var retryCount = 0;\n\n    var recursivePoll = function () {\n      if (!ref.isPolling) {\n        return Promise.reject(new AuthPollStopError());\n      }\n\n      return pollFn().then(function (pollRes) {\n        retryCount = 0;\n\n        if (pollRes.factorResult && pollRes.factorResult === 'WAITING') {\n          if (!ref.isPolling) {\n            throw new AuthPollStopError();\n          }\n\n          if (typeof transactionCallBack === 'function') {\n            transactionCallBack(pollRes);\n          }\n\n          return delay(delay$1).then(recursivePoll);\n        } else {\n          ref.isPolling = false;\n          return sdk.tx.createTransaction(pollRes);\n        }\n      }).catch(function (err) {\n        if (err.xhr && (err.xhr.status === 0 || err.xhr.status === 429) && retryCount <= 4) {\n          var delayLength = Math.pow(2, retryCount) * 1000;\n          retryCount++;\n          return delay(delayLength).then(recursivePoll);\n        }\n\n        throw err;\n      });\n    };\n\n    return recursivePoll().catch(function (err) {\n      ref.isPolling = false;\n      throw err;\n    });\n  };\n}\n\nexport { getPollFn }; //# sourceMappingURL=poll.js.map","map":null,"metadata":{},"sourceType":"module"}